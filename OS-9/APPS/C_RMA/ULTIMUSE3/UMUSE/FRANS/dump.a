* file ~vm640/dump.a* 90/7/31  Print 'pnrows' only* 90/6/26  Gemini 10X changed from 7/72 to 8/72" LF.* 90/5/26  Gemini 10X hosey-IBM added* 89/10/12 Tandy DMP-105 code merged back in* 89/9/30 Changed for Panasonic KXP1180 == Epson FX8xxx* Can do either 720 (wide) or 960 (==screen) dots/line;*   for 720, set LMargin to 5, for 960 to 12 or so.* 89/5/15 mods to allow abortion, and restore printer completely* No, abort is impossible thru pipe -- bad Sandra Day for Ms. Roe.* psect dump_a,0,0,0,0,0 nam dump_a ttl dump*GRAPHICS SCREEN DUMP FOR Epson-compatibles* HORIZONTAL  OUTPUT.  OS9 version from 85/4/19.* 640-pixel version from 88/8/23* Adapted for C calling 88/8/17; Y --> U. IFP1   USE /dd/defs/os9defs.a ENDC* extern direct ubyte *vdgram* extern direct ubyte pnrows, printypecols equ 80stdin equ 0stdout equ 1 vsect dp  Yes, DIRECT PAGEGBYTE:  RMB 2   addr of CURRENT BYTE OUTMASK:   RMB 1   Picks 1 pixel out of byte's 8 bitsCOL:    RMB 1   Current column, 0 thru 79ROW:    RMB 1   Current row, 0 thru 23 or 27 or whateverLASTROW:RMB 1   Tells Tandies to fix last lineLMARGIN:RMB 2   Pointer to LMARGIN stringINIT:   RMB 2GRAF:   RMB 2REST:   RMB 2 endsect*ENTER HERE; Choose your weapon!dump: pshs u LDX <vdgram  Extern char * STX GBYTE ldb <printype  Fran's printer code from the Pipeline decb beq DDOIT     * 1 Tandy DMP-105,6 decb beq DDOIT30   * 2 Tandy DMP-130--133, not 134 decb beq CDOIT     * 3 Tandy CGP-220 decb beq EWDOIT    * 4 Epson FX-80 Wide decb beq ENDOIT    * 5 Epson FX-80 Narrow decb beq IDOIT     * 6 IBM ProWriter, Tandy DMP-134 (yes!) decb beq GDOIT     * 7 Gemini 10X dinosaur puls u,pc     punt!* Left Margins for Tandy DMP and CGP*NOTE:  DMP-130 series treated as CGP-220;*       unable to set denser grafix pitches, can't have Left Margin.CDOITDDOIT30 leax CLMARGIN,pcr bra DCDOITDDOIT leax DLMARGIN,pcrDCDOIT stx LMARGIN lbra TANDOIT* Epson, Wide modeEWDOIT leax EWLMARG,pcr stx LMARGIN leax EWGRAF,pcr stx GRAF bra EDOITENDOIT leax ENLMARG,pcr stx LMARGIN leax ENGRAF,pcr stx GRAFEDOIT leax EINIT,pcr stx INIT leax EREST,pcr stx REST bra PANDOITIDOIT leax ILMARGIN,pcr stx LMARGIN leax IINIT,pcr stx INIT leax IGRAF,pcr stx GRAF leax IREST,pcr stx REST bra PANDOITGDOIT leax GLMARG,pcr stx LMARGIN leax GINIT,pcr stx INIT leax IGRAF,pcr     Was GGRAF but == IBM's. stx GRAF leax GREST,pcr stx RESTPANDOIT ldu LMARGIN lbsr PRINT ldu INIT LBSR PRINT****DUMP SCREEN TO Panasonic KX-1180 (Epson FX-86 or IBM Pro-II)* ROLLING MASK =MASK* COLUMN BYTE COUNT 0-79 =COL* BUILD UP CHAR = A* CURRENT WORK ADDRESS = X* CURRENT BASE ADDR = =GBYTE* CURRENT ROW = ROW* SCRATCH = B and X* ROW LOOP -- seems to set Grafix mode for each line!  Needed?? CLR ROWEROWL ldu GRAF lbsr PRINT* COLUMN-BYTE LOOP CLR COLECBYTL* COLUMN-BIT LOOP LDB #$80 STB MASKEBITL* CHAR 8-BITS LOOP (INNERMOST)*   TERMINATES WHEN INITIAL 1-BIT*     SHIFTS TO THE Carry flag. LDA #1  INIT CHAR LDX GBYTE LEAX -cols,X  work from top downECHARL LEAX +cols,X  down one pixel row LDB ,X        get the byte ANDB MASK     choose one/8 pixels ADDB #255     CARRIES IFF BIT SET ROLA          PULLS IN THAT BIT bcc ECHARL     DO ANOTHER BIT*foot of Char Loop bsr prtchr    PRINT IT!*Foot of EBITLoop LSR MASK BNE EBITL*FOOT of ECBYTL BYTE LOOP LDX GBYTE LEAX 1,X STX GBYTE LDB COL INCB STB COL CMPB #cols  ECBYTL LOOP TEST BLO ECBYTL RELOAD MASK*ROW FINISHED leau CRLF,PCR   CARRIAGE RETURN & line feed bsr PRINT LDX GBYTE  PUSH 8 PIXELS DEEPER LEAX 7*cols,X STX GBYTE*FOOT of ROW LOOP LDB ROW INCB STB ROW CMPB <pnrows  #24. or less BLT EROWL* Finished but for border* leau CRLF,pcr     Deleted 90/8/7* bsr PRINT ldu REST      Restore printer normal modes BSR PRINT puls u,pc  Cute 'C' RTS******************************* Common code to PRINT STRING GIVEN IN U,* TERM'ED BY Null-BYTE (which is NOT SENT).PRINT LDA ,U+ BEQ Tat1 bsr prtchr BRA PRINTTat1 RTS*******************************Print one char in A-reg.  Also called by inner loops.prtchr tfr a,b Into low byte pshs d  Double for C call lbsr putprtr*leas 2,s*rts      puls d,pc******************************* Tandy DMP-105 Dot Matrix and CGP-220 InkJet (B&W mode only)* OS9 version from 85/4/19.* 640-pixel version from 88/8/23* Adapted for C calling 88/8/17; Y --> U.TANDOIT clr LASTROW   ENABLE ALL DOT ROWS* Init printer for grafix leau DINIT,pcr BSR PRINT* ROW LOOP CLR ROWDROWL* Unlike Epson/IBM, Tandy can't preset a margin,*   so tab in with white grafix bytes* PRINT LEFT BORDER MARGIN ldu LMARGIN BSR PRINT* COLUMN-BYTE LOOP CLR COLDCBYTL* COLUMN-BIT LOOP LDB #$80 STB MASKDBITL* CHAR 7-BITS LOOP (INNERMOST)* TERMINATES WHEN INITIAL 1-BIT* SHIFTS TO THE SIGN POSITION. LDA #1  INIT CHAR LDX GBYTE LEAX 7*cols,X*INVERT THE OUTPUT (SET=>WHITE)DCHARL LEAX -cols,X LDB ,X ANDB MASK ADDB #255 CARRIES IFF BIT SET ROLA  PULLS IN THAT BIT BPL DCHARL  DO ANOTHER BIT*WHITEN OUT BOTTOM 4 DOTS ON LAST ROW. tst LASTROW beq DMORE ANDA #$87      just top 3 rows* ora #$08       black bottom line (not for full-score print!)DMORE bsr prtchr PRINT IT!*ENDLOOP DCHARL*FOOT of DBITL LSR MASK BNE DBITL*FOOT of DCBYTL BYTE LOOP LDX GBYTE LEAX 1,X STX GBYTE LDB COL INCB STB COL CMPB #cols  DCBYTL LOOP TEST BLO DCBYTL RELOAD MASK*ROW FINISHED LDA #13  CARRIAGE RETURN bsr prtchr LDX GBYTE  PUSH 7 PIXELS DEEPER LEAX 6*cols,X STX GBYTE*FOOT of ROW LOOP LDB ROW INCB STB ROW CMPB <pnrows  #27 BLT DROWL*If Full-Screen dump, special last-row actions lda <pnrows cmpa #27 Last row for full screen blt DDONE no special handling*LAST ROW HAS ONLY 3 DOTS if full-screen CMPB <pnrows BGT DDONE  DID 27TH ALREADY inc LASTROW   Set Boolean TRUE BRA DROWL* Finished but for borderDDONE* flow into Abort leau DREST,pcr     Restore printer normal modes lbsr PRINT* puls u,pc  Cute 'C' RTS******************************* CHAR STRINGS FOR PRINTERS* DON'T use a VSECT for these Constant strings!* At least not if you reference them ,PCR !* Assume all Tandy printers do auto LF on CR, and all others don't,*  and RBF Mode turns off SCFMan's attempts at same.CRLF FCB 13,10,0* Epson, Wide and Narrow:EWLMARG FCB 27,108,5,0        12 for 960, 5 for 720ENLMARG FCB 27,108,12,0EINIT FCB 27,35,27,65,8,0     MSB As-Is, LF=8/72"EWGRAF FCB 27,42,6,$80,2,0     Grafix Mode 6 (720), 512+128 bytesENGRAF FCB 27,42,1,$80,2,0    Grafix Mode 1 (960), 512+128EREST FCB 27,61,27,50,27,108,1,0   MSB==Zero (for Df), 12/72",LM=1** Int'l BMIINIT FCB 27,51,24,27,53,128,0 LF=24/216" = 8/72", Auto LF OffILMARGIN FCB 27,88,10,80,0    * RM < L1 so is ignoredIGRAF FCB 27,76,128,2,0IREST FCB 27,51,36,0          Lf 12/72"* Note: Gemini 10X is like IBM but wants different LF Pitch of 1/9".* 90/7/18 updated to REAL zeroxed G10X manual!  No excuses!!!GINIT FCB 27,51,16,0     New Fran's 8/72"==16/144 (Not n/72, n/216, etc.)GLMARG FCB 27,77,8,0     Cud be 5 to 12, maybe 10.  Was just NULL.*GGRAF FCB 27,76,128,2,0  Same as IBMGREST FCB 27,64,0        "Initialize Printer"* Tandy Dot Matrix* Some can turn off Auto-LF, some can't, so make them all do the LF.* NOTE:  DMP-130/132 ignore the Condensed Mode?  Why?  'Cuz it's CHEAP!DINIT FCB 27,20,27,22,18,0  Condensed chars, Auto LF, Grafix ModeDREST FCB 30,27,19,0        Text Mode, Full-sized, still auto LF* Not "set margin", but "tabbing" sent to begin each line:DLMARGIN FCB 28,64,$80,0   64 Pixels of blankness == 8 chars*DLMARGIN FCB 28,5,32,0      5 Blanks in Text mode -- NO WORKEE!* Tandy CGP-220 Ink Jet -- Same as DMPs, but no room for MarginCLMARGIN FCB 0 endsect* eof ~vm640/dump.a