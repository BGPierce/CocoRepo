/* vm640/INSTIO.C  New Instrs R/W 97/2/15*  Part of Um3E, no relation except via Soowee()*/#include "wmuse.h"#include "vmem.h"#include "fcnptrs.h"extern char    instnams[NINSTRS] [INAMEL];extern short   instvals[NINSTRS];extern int  read(), write();/* 97/2/15 Fcn to R/W new Expanded Instr tables. Format is:* short ninstrs = no. of instrs actually R/W'ed* ubyte inamel = length of names, incl. NULL term* 'ninstrs' triples of form:*   ubyte entry no.*   ubyte value (to synths)*   string of length 'inamel'*/bool instio(chan, wr)  int     chan;  bool    wr;     /* R/W */{     char     ibuff[XINAMEL];     int      instr, pass, inamel, ninstrs, copylen, nread;     short    shortemp;     ubyte    bytemp;     bool     ok = TRUE;     Reg char *cp;     if(wr) {     /* Write */          for(pass = 0; pass <= 1; pass++) {               ninstrs = 0;               for(instr=0, cp=instnams[0]; instr < NINSTRS;                 instr++, cp += INAMEL) {                    if( (instvals[instr]==0x80) && !*cp)                         continue;                    ninstrs++;                    if(pass) {     /* write out entry */                         bytemp = instr;                         write(chan, &bytemp, 1);                         bytemp = instvals[instr];                         write(chan, &bytemp, 1);                         ok &= (write(chan, cp, INAMEL) == INAMEL);                    }               }               if( !pass) {     /* write the preamble */                    shortemp = ninstrs;                    write(chan, &shortemp, 2);                    bytemp = INAMEL;                    write(chan, &bytemp, 1);               }          } /* 2-pass loop */     } /* write *//* Read */     else {          nread = read(chan, &shortemp, 2);          if(nread == 0)      /* Free pass for old short .INS files */               return(TRUE);          read(chan, &bytemp, 1);     /* Check out values */          ninstrs = shortemp & XINSTRS;          inamel = bytemp & XINAMEL;          copylen = (inamel >= INAMEL) ? (INAMEL-1) : (inamel - 1);     /* OK, read 'em in */          for( ; ninstrs; ninstrs--) {               read(chan, &bytemp, 1);               instr = bytemp & 255;               read(chan, &bytemp, 1);     /* instval */               ok &= (read(chan, ibuff, inamel) == inamel);               if(instr < NINSTRS) {     /* within our table range */                    instvals[instr] = bytemp & 0xFF;                    cp = instnams[instr];                    strncpy(cp, ibuff, copylen);                    *(cp + copylen) = '\0';               }          }     } /* Read */     return(ok);} /* instio() *//* eof instio.c */