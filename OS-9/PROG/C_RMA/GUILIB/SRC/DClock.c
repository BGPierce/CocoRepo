#include <stdio.h>#include <gui.h>#include <mouse.h>#include <os9.h>#include <time.h>#include <utime.h>#define UPDATE  3#define TIMOUT  10#define FOLLOW  1#define MOUSSIG 10#define STDIN   0#define STDOUT  1#define mox    mspack->pt_wrx#define moy    mspack->pt_wry#define mb     mspack->pt_cbsa#define gcon  SetGC(wpath,202,1)#define gcoff SetGC(wpath,0,0)MSRET *mspack;MSRET mreal;int wpath;int cksig();int sigcode;int pid;BUTTON b[10];BUTTON yes,no;TITLE t[1];int ahr[3],amn[3],aflg[3];char afile[3][32];int alrm;int MIL;int state; /* which menu state we're in */long time();char dplist[80];main(){     int lopx,lopy,oldx,oldy;     MIL=1; alrm=1;     DWEnd(wpath);     DWSet(wpath,8,0,0,40,24,2,2,2);     Select(wpath);     intercept(cksig);     _ss_mouse(wpath,UPDATE,TIMOUT,FOLLOW);     pid=getpid();     mspack=&mreal;     Clear(wpath);     defines();     Man_WN(wpath,1,1,19,7,W_SHADOWED,12);     Man_WN(wpath,20,1,33,6,W_SHADOWED,12);     for (lopx=0; lopx<5; lopx++)           Man_BT(wpath,&b[lopx],_INIZ_);     Man_TL(wpath,&t[0],_INIZ_);     PutBlk(wpath,pid,1,36*8,3*8); /* bell icon */     DTime(wpath);     for (;;) {          state=0; /* when state == 0 ; main loop */          tsleep(10);          DTime(wpath);          if(alrm) ckalrm();     }}Butpush1(){     int click,lopx,lopy,oldx,oldy;     gcoff;     _gs_mouse(STDIN,mspack);     click=-1;     for (lopx=0; lopx<5; lopx++)           if (Check_BT(wpath,&b[lopx],mox,moy))               click=lopx;     switch (click) {          case 3:               Man_BT(wpath,&b[click],_ON_);               if(sure(wpath))                 Quit(0);               Man_BT(wpath,&b[click],_OFF_);               break;          case 2:               Man_BT(wpath,&b[click],_ON_);               Set(wpath);               Man_BT(wpath,&b[click],_OFF_);               break;          case 0:               Man_BT(wpath,&b[click],_ON_);               Info();               Man_BT(wpath,&b[click],_OFF_);               break;          case 1:               Man_BT(wpath,&b[click],_ON_);               doalarm();               Man_BT(wpath,&b[click],_OFF_);               break;          case 4:               alrm=abs(alrm-1); /* toggle alarm status */               Man_BT(wpath,&b[click],abs(alrm-1));               break;          }          gcon;}Butpush2(){     register int idx;     char buffer[22];     _gs_mous(STDIN,mspack);     gcoff;     for (idx=5; idx<7; idx++)        if(Check_BT(wpath,&b[idx],mox,moy))         Man_BT(wpath,&b[idx],Toggle(&b[idx]));     MIL=b[6].bt_act;     if(CkButn(&b[5])) {     OWSet(wpath,1,5,10,30,5,13,12);     Man_WN(wpath,0,0,30,5,EW_SHADOWED,12);     CWArea(wpath,1,1,28,3);     EchoOn(0);     CurOn(wpath);     for(idx=0; idx<22; idx++)       buffer[idx]=0;     Clear(wpath);     puts("Complete\npathlist:");     CurXY(wpath,9,1);     readln(0,buffer,20);     buffer[strlen(buffer)-1]=0;     strcpy(dplist,buffer);     OWEnd(wpath);     }     gcon;}Butpush3(){     register int click;     int idx;     char buffer[22];     _gs_mouse(STDIN,mspack);     gcoff;     click=-1;     for(idx=7; idx<10; idx++)       if(Check_BT(wpath,&b[idx],mox,moy)) {         click=idx;         Man_BT(wpath,&b[click],Toggle(&b[click]));         break;       }     if(click==-1) return;     click-=7;     OWSet(wpath,1,5,18,30,5,13,12);     Man_WN(wpath,0,0,30,5,EW_SHADOWED,12);     CWArea(wpath,1,1,28,3);     EchoOn(0);     CurOn(wpath);     for(idx=0; idx<22; idx++)       buffer[idx]=0;     do {       Clear(wpath);       puts("\nTime:");       CurXY(wpath,5,1);       readln(0,buffer,6);       (char)buffer[2]=0;       ahr[click]=atoi(buffer);       amn[click]=atoi(&buffer[3]);     } while((ahr[click]<0)||(ahr[click]>23)||             (amn[click]<0)||(amn[click]>59));     for(idx=0; idx<22; idx++)       buffer[idx]=0;     Clear(wpath);     puts("\nPlay file:");     CurXY(wpath,10,1);     readln(0,buffer,20);     CurOff(wpath);     EchoOff(0);     strcpy(afile[click],buffer);     OWEnd(wpath);     gcon;}doalarm(){     register int idx;     OWSet(wpath,1,2,10,36,9,0,1);     Man_WN(wpath,0,0,36,9,W_SHADOWED);     CWArea(wpath,1,1,34,7);     BColor(wpath,12);     Clear(wpath);     for(idx=7; idx<10; idx++)       Man_BT(wpath,&b[idx],_INIZ_);     FColor(wpath,13);     for(idx=0; idx<3; idx++) {       CurXY(wpath,10,idx*2+1);       printf("%02d:%02d Sound: %-s",ahr[idx],amn[idx],afile[idx]);     }     gcon;     state=2; /* when state == 2 ; picking which alarm */     setmouse(STDIN,MOUSSIG);     pause();     gcoff;     OWEnd(wpath);}Set(path)int path;{     OWSet(path,1,22,2,10,5,12,13);     Man_WN(path,0,0,10,5,W_SHADOWED,13);     Man_BT(path,&b[5],_INIZ_);     Man_BT(path,&b[6],_INIZ_);     Man_BT(path,&b[6],MIL);     gcon;     state=1; /* when in state 1 ; picking 24 hour mode toggle */     setmouse(STDIN,MOUSSIG);     pause();     gcoff;     OWEnd(path);}ckalrm(){     long systime;     register int idx;     int hr,min;     struct tm *tm;     char parmbuf[128];     int childstat;     systime=time((char *)0);     tm=localtime(&systime);     hr=tm->tm_hour;     min=tm->tm_min;     for(idx=0; idx<3; idx++) {       if(ahr[idx]+amn[idx]==0)         continue; /* no alarm set */       if((hr==ahr[idx])&&(min==amn[idx])) {         OWSet(wpath,1,2,9,36,9,0,1);         Man_WN(wpath,0,0,36,9,EW_SHADOWED);         CWArea(wpath,1,1,34,7);         BColor(wpath,12);         FColor(wpath,13);         Clear(wpath);         strcpy(parmbuf,"play ");         strcat(parmbuf,dplist);         strcat(parmbuf,"/");         strcat(parmbuf,afile[idx]);         strcat(parmbuf,"\n");         write(1,"Executing: ",11);         write(1,parmbuf,strlen(parmbuf));         system(parmbuf);         OWEnd(wpath);         alrm=abs(alrm-1);         Man_BT(wpath,&b[4],abs(alrm-1));       }     }}DTime(path)int path;{     static long systime;     static int hr=1,min=1,ohr=-1,omin=-1,thr,OMIL=-1;     struct tm *tm;     systime=time((char *)0);     tm=localtime(&systime);     hr=tm->tm_hour;     min=tm->tm_min;     if((hr==ohr)&&(min==omin)&&(MIL==OMIL)) return;     _ss_rel(STDIN);     if (MIL!=OMIL) {       ohr=-1;       omin=-1;       OMIL=MIL;     }     if (hr!=ohr) {          thr=hr;          if (MIL) {               strcpy(t[0].tl_name,"24");                Man_TL(wpath,&t[0],_ON_);          } else {               if (hr>11) {                    strcpy(t[0].tl_name,"PM");                    Man_TL(wpath,&t[0],_OFF_);               } else {                    strcpy(t[0].tl_name,"AM");                    Man_TL(wpath,&t[0],_OFF_);               }               if (hr>12)                 thr=hr-12;               if (hr==0)                 thr==12;          }          if (thr>9) {               PutBlk(wpath,pid,(thr/10)+2,2*8,2*8);               ohr=thr-(thr/10*10);}               else {PutBlk(wpath,pid,2,2*8,2*8);               ohr=thr;}          PutBlk(wpath,pid,ohr+2,5*8,2*8);          PutBlk(wpath,pid,12,7*8+4,2*8); /* colon */          }     if (min!=omin) {          if (min>9) PutBlk(wpath,pid,(min/10)+2,10*8,2*8);            else PutBlk(wpath,pid,2,10*8,2*8);            omin=min-(min/10*10);            PutBlk(wpath,pid,omin+2,13*8,2*8);            if(!alrm) {              alrm=abs(alrm-1);              Man_BT(wpath,&b[4],abs(alrm-1));            }          }     ohr=hr; omin=min;     _ss_msig(STDIN,MOUSSIG);}tone(vol,dur,freq)char vol,dur;int freq;{      struct registers reg;      reg.rg_a=STDOUT;      reg.rg_b=0x98;      reg.rg_x=vol*256+dur;      reg.rg_y=freq;      _os9(I_SETSTT,&reg);}sure(path)int path;{     Def_BT(&yes,"Yes",4,3,BT_REG);     Def_BT(&no,"NO!",8,3,BT_REG);     OWSet(path,1,11,12,15,6,14,12);     Man_WN(path,0,0,15,6,EW_SHADOWED,12);     CurXY(path,1,1);     puts("Are you sure?");     Man_BT(path,&yes,_INIZ_);     Man_BT(path,&no,_INIZ_);     state=3; /* state switch for exit yes-no? */     gcon;     setmouse(STDIN,MOUSSIG);     pause();     OWEnd(path);}Sure(){     _gs_mous(STDIN,mspack);     gcoff;     if(Check_BT(wpath,&yes,mox,moy)) {       Man_BT(wpath,&yes,Toggle(&yes));       OWEnd(wpath);       Quit(0);     }     if(Check_BT(wpath,&no,mox,moy)) {       Man_BT(wpath,&no,Toggle(&no));       return;     }     state=3;     setmouse(STDIN,MOUSSIG);     gcon;     pause();}/*EOF*/